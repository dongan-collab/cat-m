<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è€é¼ å¤§æˆ°è²“ï¼šéˆ´éºä¿è¡›æˆ° (å¡”é˜²ç‰ˆ)</title>
    <!-- è¼‰å…¥ Tailwind CSS ç¢ºä¿éŸ¿æ‡‰å¼è¨­è¨ˆå’Œç¾è§€ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* ä½¿ç”¨ Inter å­—é«”ä¸¦ç¢ºä¿æ•´å€‹é é¢ä½ˆå±€ç¾è§€ */
        body { font-family: 'Inter', sans-serif; background-color: #f7f7f7; }
        #gameCanvas {
            border: 4px solid #333;
            background-color: #b8e0b8; /* å»šæˆ¿åœ°æ¿/è‰åœ°èƒŒæ™¯ */
            max-width: 800px;
            max-height: 600px;
            margin: 0 auto;
            display: block;
        }
        .info-card {
            background-color: #ffffff;
            border: 1px solid #ddd;
            padding: 1rem;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .mouse {
            position: absolute;
            font-size: 1.5rem;
            pointer-events: none; /* å¿½ç•¥é»æ“Šäº‹ä»¶ */
            color: #8b5cf6; /* ç´«è‰²è€é¼  */
        }
        .cat-tower {
            position: absolute;
            font-size: 2rem;
            cursor: pointer;
            color: #f97316; /* æ©˜è²“ */
            border-radius: 50%;
            background: #ffeac7;
            padding: 0.25rem;
        }
        .projectile {
            position: absolute;
            font-size: 1rem;
            pointer-events: none;
            color: #ef4444; /* ç´…è‰²æ¯›ç·šçƒ */
        }
    </style>
</head>
<body class="p-4 sm:p-8">

    <h1 class="text-3xl font-bold text-center mb-6 text-gray-800">
        è€é¼ å¤§æˆ°è²“ï¼šéˆ´éºä¿è¡›æˆ° å¡”é˜²
    </h1>

    <div id="gameContainer" class="relative max-w-4xl mx-auto rounded-xl overflow-hidden">
        <!-- éŠæˆ²ç•«å¸ƒ - ç›¸ç•¶æ–¼ Scratch çš„èˆå° -->
        <canvas id="gameCanvas" width="800" height="600" class="rounded-lg"></canvas>

        <!-- è³‡è¨Šèˆ‡æ§åˆ¶é¢æ¿ - ç›¸ç•¶æ–¼ Scratch çš„è®Šæ•¸é¡¯ç¤ºå’ŒæŒ‰éˆ• -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mt-6">
            <div class="info-card">
                <div class="text-sm font-medium text-gray-500">éˆ´éºç”Ÿå‘½ (Lives)</div>
                <div id="livesDisplay" class="text-2xl font-bold text-red-600">10</div>
            </div>
            <div class="info-card">
                <div class="text-sm font-medium text-gray-500">èµ·å¸ (é‡‘å¹£)</div>
                <div id="cheeseDisplay" class="text-2xl font-bold text-yellow-600">100</div>
            </div>
            <div class="info-card">
                <div class="text-sm font-medium text-gray-500">æ³¢æ•¸ (Wave)</div>
                <div id="waveDisplay" class="text-2xl font-bold text-blue-600">1</div>
            </div>
            <div class="info-card">
                <div class="text-sm font-medium text-gray-500">åˆ†æ•¸ (Score)</div>
                <div id="scoreDisplay" class="text-2xl font-bold text-green-600">0</div>
            </div>
        </div>

        <!-- å•†åº—å€ - è³¼è²·è²“å’ªé˜²ç¦¦å¡” -->
        <div class="flex flex-col md:flex-row justify-center space-y-4 md:space-y-0 md:space-x-4 mt-6">
            <button id="buyCat1" class="bg-indigo-500 hover:bg-indigo-600 text-white font-semibold py-3 px-6 rounded-full transition duration-150 shadow-md transform hover:scale-105">
                è³¼è²·æ©˜è²“ (ğŸŠ) - 50 èµ·å¸
            </button>
            <button id="startWave" class="bg-green-500 hover:bg-green-600 text-white font-semibold py-3 px-6 rounded-full transition duration-150 shadow-md transform hover:scale-105">
                é–‹å§‹ä¸‹ä¸€æ³¢ (Wave)
            </button>
        </div>

        <!-- éŠæˆ²è¨Šæ¯æç¤º -->
        <div id="messageBox" class="fixed inset-0 bg-black bg-opacity-75 hidden items-center justify-center p-4 z-10">
            <div class="bg-white p-8 rounded-xl shadow-2xl text-center">
                <h2 id="messageTitle" class="text-3xl font-bold text-gray-900 mb-4"></h2>
                <p id="messageContent" class="text-lg text-gray-700 mb-6"></p>
                <button id="closeMessage" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-full transition duration-150">
                    ç¢ºå®š
                </button>
            </div>
        </div>
    </div>

    <script type="module">
        // å¡”é˜²éŠæˆ²çš„æ ¸å¿ƒé‚è¼¯
        
        // --- éŠæˆ²è¨­å®š ---
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const livesDisplay = document.getElementById('livesDisplay');
        const cheeseDisplay = document.getElementById('cheeseDisplay');
        const waveDisplay = document.getElementById('waveDisplay');
        const scoreDisplay = document.getElementById('scoreDisplay');
        const buyCat1Button = document.getElementById('buyCat1');
        const startWaveButton = document.getElementById('startWave');
        const messageBox = document.getElementById('messageBox');
        const messageTitle = document.getElementById('messageTitle');
        const messageContent = document.getElementById('messageContent');
        const closeMessage = document.getElementById('closeMessage');

        let isPlacingCat = false;
        let gameRunning = false;
        
        // éŠæˆ²ç‹€æ…‹è®Šæ•¸
        let gameState = {
            lives: 10,
            cheese: 100,
            score: 0,
            wave: 0,
            enemies: [], // è€é¼ åˆ—è¡¨
            towers: [],  // è²“å’ªé˜²ç¦¦å¡”åˆ—è¡¨
            projectiles: [], // æ¯›ç·šçƒåˆ—è¡¨
            pathIndex: 0, 
        };

        // ç°¡åŒ–çš„è€é¼ è¡Œèµ°è·¯å¾‘ (æ–°å¢ 4 å€‹æŠ˜ç·šï¼Œä½¿è·¯å¾‘æ›´æ›²æŠ˜)
        // ç¸½å…± 10 å€‹é»ï¼Œ9 å€‹è·¯æ®µ
        const path = [
            { x: 0, y: 300 },      // 1. èµ·é» (å·¦é‚Šä¸­é–“)
            { x: 100, y: 300 },
            { x: 100, y: 500 },    // 2. è½‰æŠ˜é» (ä¸‹)
            { x: 400, y: 500 },
            { x: 400, y: 200 },    // 3. è½‰æŠ˜é» (ä¸Š)
            { x: 650, y: 200 },
            { x: 650, y: 450 },    // 4. è½‰æŠ˜é» (ä¸‹)
            { x: 750, y: 450 },
            { x: 750, y: 150 },    // 5. è½‰æŠ˜é» (ä¸Š)
            { x: 800, y: 150 }     // 6. çµ‚é» (å³ä¸Šè§’é™„è¿‘)
        ];

        // --- éŠæˆ²ç‰©ä»¶é¡åˆ¥ ---

        /**
         * è€é¼  (æ•µäºº) é¡åˆ¥ã€‚
         */
        class Mouse {
            constructor(wave) {
                this.x = path[0].x;
                this.y = path[0].y;
                this.size = 20;
                this.health = 1 + wave * 0.5; 
                this.maxHealth = this.health;
                this.speed = 1 + wave * 0.05; 
                this.pathTargetIndex = 1;
                this.reward = 10;
                this.type = 'ğŸ­';
            }

            // æ›´æ–°è€é¼ çš„ä½ç½®
            update() {
                if (this.health <= 0) {
                    return true; // æ¨™è¨˜ç‚ºéœ€è¦åˆªé™¤
                }

                if (this.pathTargetIndex >= path.length) {
                    // åˆ°é”çµ‚é»
                    gameState.lives--;
                    return true; // æ¨™è¨˜ç‚ºéœ€è¦åˆªé™¤
                }

                const target = path[this.pathTargetIndex];
                const dx = target.x - this.x;
                const dy = target.y - this.y;
                const dist = Math.sqrt(dx * dx + dy * dy);

                if (dist < this.speed) {
                    this.x = target.x;
                    this.y = target.y;
                    this.pathTargetIndex++;
                } else {
                    this.x += (dx / dist) * this.speed;
                    this.y += (dy / dist) * this.speed;
                }
                return false; // ä¸éœ€è¦åˆªé™¤
            }

            // ç¹ªè£½è€é¼ 
            draw() {
                ctx.font = `${this.size}px Arial`;
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(this.type, this.x, this.y);

                // ç•«ç”Ÿå‘½æ¢
                const healthBarWidth = this.size;
                const healthRatio = this.health / this.maxHealth;
                ctx.fillStyle = '#ff0000'; // ç´…è‰²èƒŒæ™¯
                ctx.fillRect(this.x - healthBarWidth / 2, this.y - this.size, healthBarWidth, 3);
                ctx.fillStyle = '#00ff00'; // ç¶ è‰²è¡€æ¢
                ctx.fillRect(this.x - healthBarWidth / 2, this.y - this.size, healthBarWidth * healthRatio, 3);
            }
        }

        /**
         * è²“å’ª (é˜²ç¦¦å¡”) é¡åˆ¥ã€‚
         */
        class CatTower {
            constructor(x, y, cost, range, damage, fireRate) {
                this.x = x;
                this.y = y;
                this.cost = cost;
                this.range = range;
                this.damage = damage;
                this.fireRate = fireRate; // æ¯æ¬¡æ”»æ“Šé–“éš”çš„å¹€æ•¸
                this.fireCooldown = 0;
                this.type = 'ğŸ±';
            }

            // è²“å’ªçš„æ”»æ“Šé‚è¼¯
            update() {
                if (this.fireCooldown > 0) {
                    this.fireCooldown--;
                    return;
                }

                // å°‹æ‰¾æœ€è¿‘çš„æ•µäºº
                const target = gameState.enemies.find(enemy => {
                    const dx = enemy.x - this.x;
                    const dy = enemy.y - this.y;
                    return Math.sqrt(dx * dx + dy * dy) <= this.range;
                });

                if (target) {
                    // æ‰¾åˆ°ç›®æ¨™ï¼Œç™¼å°„æŠ•å°„ç‰©
                    gameState.projectiles.push(new Projectile(this.x, this.y, target, this.damage));
                    this.fireCooldown = this.fireRate;
                }
            }

            // ç¹ªè£½è²“å’ª
            draw() {
                ctx.font = '30px Arial';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(this.type, this.x, this.y);
            }
        }

        /**
         * æ¯›ç·šçƒ (æŠ•å°„ç‰©) é¡åˆ¥ã€‚
         */
        class Projectile {
            constructor(x, y, target, damage) {
                this.x = x;
                this.y = y;
                this.damage = damage;
                this.speed = 10;
                this.target = target; // ç›®æ¨™è€é¼ 
                this.type = 'ğŸ§¶'; // æ¯›ç·šçƒ
                
                // è¨ˆç®—ç§»å‹•æ–¹å‘
                const dx = target.x - x;
                const dy = target.y - y;
                const dist = Math.sqrt(dx * dx + dy * dy);
                this.vx = (dx / dist) * this.speed;
                this.vy = (dy / dist) * this.speed;
            }

            // æ›´æ–°æŠ•å°„ç‰©ä½ç½®å’Œç¢°æ’åµæ¸¬
            update() {
                this.x += this.vx;
                this.y += this.vy;

                // ç°¡åŒ–ç¢°æ’åµæ¸¬ï¼šæª¢æŸ¥æ˜¯å¦æ¥è¿‘ç›®æ¨™è€é¼ 
                if (this.target.health > 0 && Math.abs(this.x - this.target.x) < 15 && Math.abs(this.y - this.target.y) < 15) {
                    this.target.health -= this.damage;
                    
                    if (this.target.health <= 0) {
                        // è€é¼ è¢«æ“Šæ•—ï¼Œå¢åŠ è³‡æº
                        gameState.cheese += this.target.reward;
                        gameState.score++;
                    }

                    return true; // æ¨™è¨˜ç‚ºéœ€è¦åˆªé™¤ (æŠ•å°„ç‰©)
                }

                // å¦‚æœç›®æ¨™è€é¼ æ¶ˆå¤±äº†ï¼Œæˆ–è€…æŠ•å°„ç‰©é£›å¤ªé ï¼Œå‰‡åˆªé™¤
                if (this.target.health <= 0 || this.x < 0 || this.x > canvas.width || this.y < 0 || this.y > canvas.height) {
                     return true;
                }

                return false; // ä¸éœ€è¦åˆªé™¤
            }

            // ç¹ªè£½æŠ•å°„ç‰©
            draw() {
                ctx.font = '16px Arial';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(this.type, this.x, this.y);
            }
        }

        // --- éŠæˆ²ä¸»å¾ªç’° (æ¢å¾©åˆ°ç„¡åœ°å½¢çš„ç¹ªè£½é‚è¼¯) ---

        function gameLoop() {
            if (!gameRunning) return;

            // 1. æ¸…ç©ºç•«å¸ƒ (èƒŒæ™¯è‰²ä¿æŒ canvas é è¨­çš„ #b8e0b8)
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // 2. ç¹ªè£½è·¯å¾‘
            ctx.strokeStyle = '#a0522d'; // æ£•è‰²
            ctx.lineWidth = 40;
            ctx.lineCap = 'round';
            ctx.beginPath();
            ctx.moveTo(path[0].x, path[0].y);
            path.forEach(p => ctx.lineTo(p.x, p.y));
            ctx.stroke();
            
            // ç¹ªè£½éˆ´éºçµ‚é»
            ctx.font = '50px Arial';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            // çµ‚é»ç‚º (800, 150)ï¼Œå°‡éˆ´éºç¹ªè£½åœ¨è·¯å¾‘çµ‚é»
            ctx.fillText('ğŸ””', path[path.length - 1].x - 30, path[path.length - 1].y); 

            // 3. æ›´æ–°èˆ‡ç¹ªè£½æ•µäºº (è€é¼ )
            gameState.enemies = gameState.enemies.filter(enemy => {
                const remove = enemy.update(); 
                if (!remove) {
                    enemy.draw();
                }
                return !remove; 
            });

            // 4. æ›´æ–°èˆ‡ç¹ªè£½é˜²ç¦¦å¡” (è²“å’ª)
            gameState.towers.forEach(tower => {
                tower.update();
                tower.draw();
            });

            // 5. æ›´æ–°èˆ‡ç¹ªè£½æŠ•å°„ç‰© (æ¯›ç·šçƒ)
            gameState.projectiles = gameState.projectiles.filter(proj => {
                const remove = proj.update();
                if (!remove) {
                    proj.draw();
                }
                return !remove;
            });

            // 6. æ›´æ–°é¡¯ç¤ºæ•¸å€¼
            updateUI();
            
            // 7. æª¢æŸ¥éŠæˆ²æ˜¯å¦çµæŸ
            if (gameState.lives <= 0) {
                endGame(false);
                return; 
            }
            
            // 8. æª¢æŸ¥æ³¢æ•¸æ˜¯å¦çµæŸ
            const currentWaveConfig = getWaveConfig(gameState.wave);
            if (gameState.wave > 0 && gameState.enemies.length === 0 && mouseSpawnedCount >= currentWaveConfig.count) {
                startWaveButton.disabled = false;
                startWaveButton.textContent = `é–‹å§‹ç¬¬ ${gameState.wave + 1} æ³¢!`;
            }

            requestAnimationFrame(gameLoop);
        }

        function updateUI() {
            livesDisplay.textContent = gameState.lives;
            cheeseDisplay.textContent = gameState.cheese;
            waveDisplay.textContent = gameState.wave;
            scoreDisplay.textContent = gameState.score;
        }

        // --- å‹•æ…‹æ³¢æ•¸è¨­å®š (ç„¡é™é—œå¡é‚è¼¯ä¿ç•™) ---

        /**
         * æ ¹æ“šæ³¢æ•¸å‹•æ…‹è¨ˆç®—é›£åº¦ (è€é¼ æ•¸é‡ã€è¡€é‡ä¹˜æ•¸ã€ç”Ÿæˆå»¶é²)ã€‚
         */
        function getWaveConfig(waveNumber) {
            if (waveNumber <= 0) {
                return { count: 0, delay: 0, healthMultiplier: 0 };
            }

            const baseCount = 5; 
            const countGrowth = 2; 
            const healthGrowth = 0.5; 
            const initialDelay = 1500; 
            const delayReduction = 50; 
            const minDelay = 500; 

            const count = baseCount + (waveNumber - 1) * countGrowth;
            const healthMultiplier = 1.0 + (waveNumber - 1) * healthGrowth;
            const delay = Math.max(minDelay, initialDelay - (waveNumber - 1) * delayReduction);

            return { count, delay, healthMultiplier };
        }

        let mouseSpawnedCount = 0;

        // é–‹å§‹æ³¢æ•¸
        function startWave() {
            startWaveButton.disabled = true;
            gameState.wave++;
            mouseSpawnedCount = 0;

            const currentWave = getWaveConfig(gameState.wave);
            
            function spawnMouse() {
                if (mouseSpawnedCount < currentWave.count) {
                    const newMouse = new Mouse(gameState.wave);
                    gameState.enemies.push(newMouse);
                    mouseSpawnedCount++;

                    newMouse.health *= currentWave.healthMultiplier;
                    newMouse.maxHealth = newMouse.health;

                    setTimeout(spawnMouse, currentWave.delay);
                }
            }
            spawnMouse();
        }

        // çµæŸéŠæˆ²
        function endGame(won) {
            gameRunning = false;
            showMessage('ğŸ’” éŠæˆ²å¤±æ•—', `è€é¼ å·èµ°äº†éˆ´éºï¼æ‚¨æˆåŠŸå®ˆä½äº† ${gameState.wave} æ³¢ï¼Œç¸½å¾—åˆ†æ˜¯ ${gameState.score} åˆ†ã€‚`);
        }

        // é¡¯ç¤ºè¨Šæ¯æ¡†
        function showMessage(title, content) {
            messageTitle.textContent = title;
            messageContent.textContent = content;
            messageBox.classList.remove('hidden');
            messageBox.classList.add('flex');
        }

        // éš±è—è¨Šæ¯æ¡†
        closeMessage.onclick = () => {
            messageBox.classList.remove('flex');
            messageBox.classList.add('hidden');
        };

        // --- ç©å®¶äº’å‹• (è³¼è²·è²“å’ª) ---

        buyCat1Button.onclick = () => {
            if (gameState.cheese >= 50 && !isPlacingCat) {
                isPlacingCat = true;
                buyCat1Button.textContent = 'é»æ“Šç•«å¸ƒæ”¾ç½®è²“å’ª...';
                buyCat1Button.disabled = true;
            } else if (isPlacingCat) {
                 // å–æ¶ˆæ”¾ç½®
                isPlacingCat = false;
                buyCat1Button.textContent = 'è³¼è²·æ©˜è²“ (ğŸŠ) - 50 èµ·å¸';
                buyCat1Button.disabled = false;
            }
        };

        canvas.onclick = (event) => {
            if (isPlacingCat) {
                // è¨ˆç®—é»æ“Šåº§æ¨™åœ¨ç•«å¸ƒä¸Šçš„ä½ç½®
                const rect = canvas.getBoundingClientRect();
                const x = event.clientX - rect.left;
                const y = event.clientY - rect.top;

                // åŸºç¤è²“å’ªå±¬æ€§ (å·²ç§»é™¤åœ°å½¢å¢ç›Šé‚è¼¯)
                const baseRange = 150;
                const baseDamage = 1.0;
                const baseFireRate = 30;

                const newCat = new CatTower(
                    x, y, 
                    50, 
                    baseRange,
                    baseDamage,
                    baseFireRate
                );

                gameState.towers.push(newCat);
                gameState.cheese -= newCat.cost;

                // çµæŸæ”¾ç½®æ¨¡å¼
                isPlacingCat = false;
                buyCat1Button.textContent = 'è³¼è²·æ©˜è²“ (ğŸŠ) - 50 èµ·å¸';
                buyCat1Button.disabled = false;
                updateUI();
            }
        };

        startWaveButton.onclick = startWave;

        // --- éŠæˆ²åˆå§‹åŒ– ---

        function initGame() {
            // é‡è¨­æ‰€æœ‰ç‹€æ…‹
            gameState.lives = 10;
            gameState.cheese = 100;
            gameState.score = 0;
            gameState.wave = 0;
            gameState.enemies = [];
            gameState.towers = [];
            gameState.projectiles = [];
            
            updateUI();
            gameRunning = true;
            startWaveButton.disabled = false;
            startWaveButton.textContent = `é–‹å§‹ç¬¬ 1 æ³¢ (Wave)`;
            // ç¢ºä¿æ–‡å­—ç½®ä¸­è¨­å®š
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            requestAnimationFrame(gameLoop);
        }

        window.onload = initGame;
    </script>
</body>
</html>
